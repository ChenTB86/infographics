<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advertiser Budget Allocation Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- D3.js (often a dependency or useful alongside Plotly) -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Plotly.js for charting -->
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <style>
        /* Custom styles for a polished look */
        body {
            font-family: 'Inter', sans-serif;
        }
        .chart-container {
            transition: all 0.3s ease-in-out;
            min-height: 500px; /* Increased height for legend */
        }
        .filter-select, .chart-toggle button {
            transition: all 0.2s ease;
        }
        .chart-toggle button.active {
            background-color: #10B981; /* Emerald 500 */
            color: white;
            font-weight: 600;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">

        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Advertiser Performance Dashboard</h1>
            <p class="text-gray-600 mt-1">Visualize budget allocation and performance against network benchmarks.</p>
        </header>

        <!-- Controls -->
        <div class="bg-white p-4 rounded-xl shadow-md mb-8">
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6 items-start">
                
                <!-- Filters -->
                <div class="md:col-span-3 lg:col-span-2">
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">Filters</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label for="advertiser-filter" class="block text-sm font-medium text-gray-600">Advertiser</label>
                            <select id="advertiser-filter" class="filter-select mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm rounded-md"></select>
                        </div>
                        <div>
                            <label for="geo-filter" class="block text-sm font-medium text-gray-600">Traffic Geo</label>
                            <select id="geo-filter" class="filter-select mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm rounded-md"></select>
                        </div>
                         <div>
                            <label for="metric-filter" class="block text-sm font-medium text-gray-600">Metric</label>
                            <select id="metric-filter" class="filter-select mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm rounded-md">
                                <option value="share_of_budget">Share of Budget</option>
                                <option value="ctr">CTR</option>
                                <option value="cvr">CVR</option>
                                <option value="cpa">CPA</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Chart Type Toggle -->
                <div class="lg:col-span-2">
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">Visualization Type</h3>
                    <div id="chart-type-toggle" class="chart-toggle inline-flex rounded-md shadow-sm">
                        <button type="button" data-type="column" class="active relative inline-flex items-center px-4 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:z-10 focus:outline-none focus:ring-1 focus:ring-emerald-500 focus:border-emerald-500">Column</button>
                        <button type="button" data-type="treemap" class="relative inline-flex items-center px-4 py-2 border-t border-b border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:z-10 focus:outline-none focus:ring-1 focus:ring-emerald-500 focus:border-emerald-500">Treemap</button>
                        <button type="button" data-type="radar" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:z-10 focus:outline-none focus:ring-1 focus:ring-emerald-500 focus:border-emerald-500">Radar</button>
                        <button type="button" data-type="bubble" class="relative inline-flex items-center px-4 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:z-10 focus:outline-none focus:ring-1 focus:ring-emerald-500 focus:border-emerald-500">Bubble</button>
                    </div>
                </div>

                <!-- Data Controls -->
                <div class="lg:col-span-1">
                     <h3 class="text-lg font-semibold mb-2 text-gray-700">Data Controls</h3>
                     <div class="flex flex-col space-y-2">
                        <label for="csv-upload" class="w-full inline-flex justify-center items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 cursor-pointer">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                            Upload CSV
                        </label>
                        <input type="file" id="csv-upload" class="hidden" accept=".csv">
                        <button id="csv-download" class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-emerald-600 hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            Download CSV
                        </button>
                        <p id="file-name" class="text-xs text-gray-500 mt-1 truncate"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div id="charts-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Chart containers will be dynamically inserted here -->
        </div>

    </div>

    <script>
        // --- DATA ---
        let rawData = [];
        const DIMENSIONS = ['publisher_region', 'supply_type', 'platform', 'format'];
        
        const state = {
            advertiser: '',
            traffic_geo: 'All',
            metric: 'share_of_budget',
            chartType: 'column',
        };
        
        // --- FORMATTING HELPER ---
        function formatMetric(value, metricName) {
            if (value === null || typeof value === 'undefined' || isNaN(value)) return 'N/A';
            try {
                switch (metricName) {
                    case 'share_of_budget':
                        return new Intl.NumberFormat('en-US', { style: 'percent', maximumFractionDigits: 0 }).format(value);
                    case 'ctr':
                    case 'cvr':
                        return new Intl.NumberFormat('en-US', { style: 'percent', minimumFractionDigits: 1, maximumFractionDigits: 1 }).format(value);
                    case 'cpa':
                        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(value);
                    default:
                        return value.toFixed(2);
                }
            } catch (e) {
                console.error("Formatting error for", value, metricName, e);
                return value;
            }
        }

        // --- MOCK DATA GENERATION ---
        function generateMockData() {
            const advertisers = ['NIKE', 'Adidas', 'Puma'];
            const geos = ['US', 'UK', 'DE', 'FR'];
            const publisher_regions = ['MSFT', 'Yahoo', 'Traditional Pubs', 'Carriers'];
            const supply_types = ['editorial', 'mail', 'lockscreen', 'carrier content apps'];
            const platforms = ['mobile', 'desktop', 'tablet'];
            const formats = ['native - static', 'native-motion', 'display - 200X300', 'display - other'];
            let data = [];
            const randomMetric = (base, variance) => Math.max(0, base + (Math.random() - 0.5) * variance);

            advertisers.forEach(adv => {
                geos.forEach(geo => {
                    publisher_regions.forEach(pr => {
                        supply_types.forEach(st => {
                            platforms.forEach(p => {
                                formats.forEach(f => {
                                    let budget_adv_factor = 1, ctr_adv_factor = 1, cvr_adv_factor = 1, cpa_adv_factor = 1;
                                    
                                    // Create "interesting" profiles
                                    if (adv === 'NIKE') { // Strong on mobile, MSFT, native-motion. High CTR, high CPA.
                                        budget_adv_factor = (p === 'mobile' ? 1.8 : 0.7) * (pr === 'MSFT' ? 1.6 : 0.8) * (f === 'native-motion' ? 2.0 : 0.6);
                                        ctr_adv_factor = 1.3; cvr_adv_factor = 1.1; cpa_adv_factor = 1.4;
                                    } else if (adv === 'Adidas') { // Focus on desktop, display, traditional pubs. Balanced.
                                        budget_adv_factor = (p === 'desktop' ? 2.0 : 0.6) * (pr === 'Traditional Pubs' ? 1.5 : 0.9) * (f.includes('display') ? 1.7 : 0.7);
                                        ctr_adv_factor = 1.0; cvr_adv_factor = 1.05; cpa_adv_factor = 0.9;
                                    } else if (adv === 'Puma') { // Niche strategy: high CVR on lockscreen/mail, low CPA.
                                        budget_adv_factor = (st === 'lockscreen' ? 2.2 : 0.8) * (st === 'mail' ? 1.8 : 0.9);
                                        ctr_adv_factor = 0.85; cvr_adv_factor = 1.5; cpa_adv_factor = 0.7;
                                    }

                                    data.push({
                                        advertiser: adv, traffic_geo: geo, publisher_region: pr, supply_type: st, platform: p, format: f,
                                        share_of_budget: randomMetric(0.1, 0.08) * budget_adv_factor,
                                        ctr: randomMetric(0.02, 0.01) * ctr_adv_factor,
                                        cvr: randomMetric(0.05, 0.02) * cvr_adv_factor,
                                        cpa: randomMetric(10, 5) * cpa_adv_factor,
                                    });
                                    data.push({
                                        advertiser: 'Network Wide', traffic_geo: geo, publisher_region: pr, supply_type: st, platform: p, format: f,
                                        share_of_budget: randomMetric(0.1, 0.08),
                                        ctr: randomMetric(0.018, 0.01),
                                        cvr: randomMetric(0.045, 0.03),
                                        cpa: randomMetric(12, 7),
                                    });
                                });
                            });
                        });
                    });
                });
            });

            // Normalize share_of_budget
            const normalizedData = [];
            const groups = d3.group(data, d => d.advertiser, d => d.traffic_geo);
            groups.forEach(geoGroup => {
                geoGroup.forEach(advData => {
                    const totalBudget = d3.sum(advData, d => d.share_of_budget);
                    advData.forEach(row => {
                        row.share_of_budget = totalBudget > 0 ? row.share_of_budget / totalBudget : 0;
                        normalizedData.push(row);
                    })
                });
            });
            return normalizedData;
        }

        // --- UI INITIALIZATION & EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            rawData = generateMockData();
            initializeApp();
            
            document.getElementById('advertiser-filter').addEventListener('change', e => { state.advertiser = e.target.value; renderAllCharts(); });
            document.getElementById('geo-filter').addEventListener('change', e => { state.traffic_geo = e.target.value; renderAllCharts(); });
            document.getElementById('metric-filter').addEventListener('change', e => { state.metric = e.target.value; renderAllCharts(); });
            document.getElementById('csv-upload').addEventListener('change', handleFileUpload);
            document.getElementById('csv-download').addEventListener('click', handleDownloadCSV);
            document.getElementById('chart-type-toggle').addEventListener('click', e => {
                if (e.target.tagName === 'BUTTON') {
                    document.querySelectorAll('#chart-type-toggle button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    state.chartType = e.target.dataset.type;
                    renderAllCharts();
                }
            });
        });
        
        // --- TEXT WRAPPING HELPER ---
        function wrapLabels(labels, maxLength = 15) {
            return labels.map(label => {
                if (typeof label !== 'string' || label.length <= maxLength) return label;
                const words = label.split(' ');
                let currentLine = '';
                const lines = [];
                for (const word of words) {
                    if ((currentLine + word).length > maxLength && currentLine.length > 0) {
                        lines.push(currentLine.trim());
                        currentLine = '';
                    }
                    currentLine += word + ' ';
                }
                lines.push(currentLine.trim());
                return lines.join('<br>');
            });
        }

        function initializeApp() {
            populateFilters();
            createChartContainers();
            renderAllCharts();
        }

        function populateFilters() {
            const advertisers = [...new Set(rawData.map(d => d.advertiser))].filter(d => d !== 'Network Wide').sort();
            const geos = ['All', ...new Set(rawData.map(d => d.traffic_geo))].sort();
            const advFilter = document.getElementById('advertiser-filter');
            advFilter.innerHTML = advertisers.map(a => `<option value="${a}">${a}</option>`).join('');
            state.advertiser = advertisers[0];
            const geoFilter = document.getElementById('geo-filter');
            geoFilter.innerHTML = geos.map(g => `<option value="${g}">${g}</option>`).join('');
        }

        function createChartContainers() {
            const grid = document.getElementById('charts-grid');
            grid.innerHTML = '';
            DIMENSIONS.forEach(dim => {
                const title = dim.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                const container = document.createElement('div');
                container.className = 'chart-container bg-white p-4 rounded-xl shadow-md flex flex-col';
                container.innerHTML = `
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">${title}</h3>
                    <div id="chart-${dim}" class="w-full flex-grow"></div>
                    <div id="loader-${dim}" class="loader-container hidden items-center justify-center flex-grow"><div class="loader"></div></div>
                    <div id="callout-${dim}" class="text-sm text-gray-700 mt-3 p-3 bg-gray-50 rounded-md border border-gray-200"></div>
                `;
                grid.appendChild(container);
            });
        }
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            document.getElementById('file-name').textContent = file.name;
            Papa.parse(file, {
                header: true, skipEmptyLines: true, dynamicTyping: true,
                complete: (results) => { rawData = results.data; initializeApp(); },
                error: (error) => { console.error("CSV Parsing Error:", error); alert("Error parsing CSV file."); }
            });
        }
        
        function handleDownloadCSV() {
            const csv = Papa.unparse(rawData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "advertiser_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // --- DATA PROCESSING ---
        const filterData = () => rawData.filter(d => (state.traffic_geo === 'All' || d.traffic_geo === state.traffic_geo) && (d.advertiser === state.advertiser || d.advertiser === 'Network Wide'));
        
        function processDataForDimension(filteredData, dimension) {
            const grouped = d3.group(filteredData, d => d[dimension], d => d.advertiser);
            const result = [];
            grouped.forEach((advertiserGroup, dimValue) => {
                const advData = advertiserGroup.get(state.advertiser);
                const netData = advertiserGroup.get('Network Wide');
                if (advData && netData) {
                    result.push({
                        dimensionValue: dimValue,
                        advertiserMetric: d3.mean(advData, d => d[state.metric]),
                        networkMetric: d3.mean(netData, d => d[state.metric]),
                        bubbleSizeMetric: d3.mean(advData, d => d.ctr),
                        bubbleColorMetric: d3.mean(advData, d => d.cvr),
                    });
                }
            });
            return result.sort((a, b) => d3.descending(a.advertiserMetric, b.advertiserMetric));
        }

        // --- CHART RENDERING ---
        function renderAllCharts() {
            const filteredData = filterData();
            DIMENSIONS.forEach(dim => {
                const chartData = processDataForDimension(filteredData, dim);
                renderChart(dim, chartData);
                renderCallouts(dim, chartData);
            });
        }

        function renderCallouts(dimension, data) {
            const calloutDiv = document.getElementById(`callout-${dimension}`);
            if (!data || data.length < 2) {
                calloutDiv.innerHTML = '<em>Not enough data for comparison.</em>';
                return;
            }

            const isLowerBetter = state.metric === 'cpa';
            let bestGap = { value: -Infinity, label: '', rawDiff: 0 };
            let worstGap = { value: Infinity, label: '', rawDiff: 0 };

            data.forEach(d => {
                const diff = d.advertiserMetric - d.networkMetric;
                const performanceGap = isLowerBetter ? -diff : diff;
                if (performanceGap > bestGap.value) { bestGap = { value: performanceGap, label: d.dimensionValue, rawDiff: diff }; }
                if (performanceGap < worstGap.value) { worstGap = { value: performanceGap, label: d.dimensionValue, rawDiff: diff }; }
            });
            
            let calloutText = '';
            if (bestGap.label && bestGap.value > 0) {
                const formattedDiff = formatMetric(Math.abs(bestGap.rawDiff), state.metric);
                const comparison = isLowerBetter ? 'better' : 'higher';
                calloutText += `<strong>Top Performer:</strong> ${bestGap.label} (${comparison} by ${formattedDiff}). `;
            } else { calloutText += `No significant outperformance. `; }

            if (worstGap.label && bestGap.label !== worstGap.label && worstGap.value < 0) {
                const formattedDiff = formatMetric(Math.abs(worstGap.rawDiff), state.metric);
                const comparison = isLowerBetter ? 'worse' : 'lower';
                 calloutText += `<strong>Improvement Area:</strong> ${worstGap.label} (${comparison} by ${formattedDiff}).`;
            }
            calloutDiv.innerHTML = calloutText;
        }
        
        function renderChart(dimension, data) {
            const chartDiv = `chart-${dimension}`;
            const loaderDiv = document.getElementById(`loader-${dimension}`);
            const chartElement = document.getElementById(chartDiv);
            
            if (!data || data.length === 0) {
                 chartElement.innerHTML = `<div class="flex items-center justify-center h-full text-gray-500">No data for current selection.</div>`;
                 return;
            }

            loaderDiv.classList.remove('hidden'); loaderDiv.classList.add('flex'); chartElement.classList.add('hidden');

            const originalLabels = data.map(d => d.dimensionValue);
            const labels = wrapLabels(originalLabels); // Wrap long labels
            const advertiserValues = data.map(d => d.advertiserMetric);
            const networkValues = data.map(d => d.networkMetric);
            const metricTitle = state.metric.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            const baseLayout = {
                margin: { l: 60, r: 30, b: 180, t: 40 }, // Increased bottom margin for wrapped labels
                legend: { x: 0.5, y: -0.5, xanchor: 'center', orientation: 'h' },
                paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                font: { family: 'Inter, sans-serif', color: '#374151' },
                xaxis: { 
                    automargin: true
                }, 
                yaxis: { automargin: true }
            };

            let plotData, layout;
            switch (state.chartType) {
                case 'column':
                    plotData = [
                        { x: labels, y: advertiserValues, name: state.advertiser, type: 'bar', marker: { color: '#10B981' } },
                        { x: labels, y: networkValues, name: 'Network Benchmark', type: 'bar', marker: { color: '#6B7280' } }
                    ];
                    layout = { ...baseLayout, barmode: 'group', title: `${metricTitle}`, yaxis: { title: metricTitle } };
                    break;
                case 'treemap':
                    plotData = [{ type: 'treemap', labels: labels, parents: Array(labels.length).fill(""), values: advertiserValues, textinfo: 'label+value+percent root', marker: { colorscale: 'Emeralds' } }];
                    layout = { ...baseLayout, title: `${metricTitle} for ${state.advertiser}` };
                    break;
                case 'radar':
                     plotData = [
                        { type: 'scatterpolar', r: advertiserValues, theta: labels, fill: 'toself', name: state.advertiser, marker: { color: '#10B981' } },
                        { type: 'scatterpolar', r: networkValues, theta: labels, fill: 'toself', name: 'Network Benchmark', marker: { color: '#6B7280' }, opacity: 0.6 }
                    ];
                    layout = { ...baseLayout, title: `${metricTitle}`, polar: { radialaxis: { visible: true, range: [0, Math.max(...advertiserValues.concat(networkValues)) * 1.1] } } };
                    break;
                case 'bubble':
                    const hoverText = data.map(d => 
                        `<b>${d.dimensionValue}</b><br>` +
                        `${metricTitle}: ${formatMetric(d.advertiserMetric, state.metric)}<br>` +
                        `CTR: ${formatMetric(d.bubbleSizeMetric, 'ctr')}<br>`+
                        `CVR: ${formatMetric(d.bubbleColorMetric, 'cvr')}`
                    );
                    plotData = [{
                        x: labels, y: advertiserValues, mode: 'markers', text: hoverText, hoverinfo: 'text', name: state.advertiser,
                        marker: {
                            size: data.map(d => d.bubbleSizeMetric * 2500 + 5), color: data.map(d => d.bubbleColorMetric),
                            colorscale: 'Emeralds', showscale: true, colorbar: { title: 'CVR' }
                        },
                    }];
                    layout = { ...baseLayout, title: `${metricTitle} vs. Performance`, yaxis: { title: metricTitle }, xaxis: { title: dimension.replace('_', ' ') } };
                    break;
            }
            
            setTimeout(() => {
                Plotly.newPlot(chartDiv, plotData, layout, {responsive: true, displaylogo: false});
                loaderDiv.classList.add('hidden'); loaderDiv.classList.remove('flex'); chartElement.classList.remove('hidden');
            }, 200);
        }
    </script>
</body>
</html>



